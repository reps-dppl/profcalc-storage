<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>ProfCalc & Storage</title>

<link rel="icon" type="image/png" href="https://i.ibb.co/68X6G7M/profcalc-icon.png">
<link rel="apple-touch-icon" href="https://i.ibb.co/68X6G7M/profcalc-icon.png">

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root {
  --bg: #0f121a; 
  --bg-grad: linear-gradient(135deg, #0f121a 0%, #1a1f2e 100%);
  --card-bg: rgba(30, 35, 50, 0.7); 
  --border: rgba(255, 255, 255, 0.1);
  --text: #f0f2f5; --muted: #a0a8b9; --accent: #00f2ff;
  --accent-grad: linear-gradient(135deg, #00f2ff, #7000ff);
  --success: #3ddc97; --danger: #ff4d4d; --warning: #ffab00;
}
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body { 
    margin: 0; font-family: -apple-system, sans-serif; color: var(--text); 
    background: var(--bg-grad); background-attachment: fixed;
    min-height: 100vh; padding-bottom: 120px; 
}
.app { max-width: 600px; margin: auto; padding: 12px; }

.tag-container { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 8px; }
.tag { font-size: 10px; padding: 3px 8px; border-radius: 6px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); }
.tag.brand { border-color: var(--accent); color: var(--accent); font-weight: bold; }
.tag.model { border-color: #7000ff; color: #bd8aff; }

.stock-item { background: var(--card-bg); backdrop-filter: blur(10px); border: 1px solid var(--border); border-radius: 24px; padding: 20px; margin-bottom: 15px; position: relative; }
.img-container { width: 100%; display: flex; gap: 8px; overflow-x: auto; border-radius: 12px; margin-bottom: 12px; }
.img-container img { width: 110px; height: 110px; object-fit: cover; border-radius: 10px; border: 1px solid var(--border); flex-shrink: 0; }

.price-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin: 10px 0; }
.p-box { background: rgba(0,0,0,0.2); padding: 6px 2px; border-radius: 10px; text-align: center; border: 1px solid var(--border); }
.p-box span { font-size: 7px; color: var(--muted); display: block; }
.p-box strong { font-size: 10px; }

input, select { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid var(--border); background: rgba(255,255,255,0.05); color: inherit; font-size: 14px; margin-bottom: 10px; }
label { font-size: 9px; color: var(--muted); margin-bottom: 3px; display: block; font-weight: 700; text-transform: uppercase; }
.primary-btn { width: 100%; padding: 16px; border-radius: 16px; border: none; background: var(--accent-grad); color: white; font-weight: 700; cursor: pointer; }

.tabs { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(15, 18, 26, 0.9); backdrop-filter: blur(15px); border-top: 1px solid var(--border); display: flex; padding: 12px 10px 35px; z-index: 100; }
.tab { color: var(--muted); text-align: center; font-size: 10px; flex: 1; cursor: pointer; }
.tab.active { color: var(--accent); }
.tab i { font-size: 20px; margin-bottom: 4px; display: block; }

.view { display: none; }
.view.active { display: block; }
.modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 2000; }
#qr-hidden { position: absolute; left: -9999px; }
.link-icon { position: absolute; top: 20px; right: 20px; color: var(--accent); font-size: 18px; text-decoration: none; }
</style>
</head>
<body>

<div id="qr-hidden"></div>
<div id="lb" class="modal" onclick="this.style.display='none'"><img id="lb-img" style="max-width:95%; border-radius:15px;"></div>

<div class="app">
  <div class="header" style="padding: 10px 0; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
    <h1 style="margin:0; font-size:18px; font-weight:800; background: var(--accent-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">ProfCalc & Storage</h1>
    <button onclick="exportCSV()" style="background:var(--card-bg); border:1px solid var(--border); color:var(--text); font-size:10px; padding:6px 12px; border-radius:10px;">CSV</button>
  </div>

  <div id="view-stock" class="view active">
    <input type="text" id="searchInput" placeholder="Suche (Name, SKU, Kunde)..." oninput="renderStock()" style="margin: 15px 0;">
    <div id="stockList">LÃ¤dt Daten...</div>
  </div>

  <div id="view-add" class="view">
    <div class="stock-item" style="margin-top:20px;">
      <label>Produkt Name</label><input id="name" type="text" placeholder="z.B. Jordan 4 Military">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
        <div><label>Marke</label><select id="brandSelect"></select></div>
        <div><label>Modell</label><select id="modelSelect"></select></div>
        <div><label>Farbe</label><select id="colorSelect"></select></div>
        <div><label>GrÃ¶ÃŸe</label><input id="special" type="text"></div>
        <div><label>EK (â‚¬)</label><input id="ek" type="number" oninput="calcByPrice()"></div>
        <div><label>Marge (%)</label><input id="margeInput" type="number" oninput="calcByMarge()"></div>
        <div style="grid-column: span 2;"><label>VK (â‚¬)</label><input id="vk" type="number" oninput="calcByPrice()"></div>
        <div><label>Zustand</label>
          <select id="condition">
            <option value="DS">DS (New)</option>
            <option value="VNDS">VNDS</option>
            <option value="Used">Used</option>
          </select>
        </div>
        <div><label>Regal / Platz</label><input id="shelf" type="text" placeholder="A1"></div>
        <div style="grid-column: span 2;"><label>Kunde</label><input id="customer" type="text"></div>
        <div style="grid-column: span 2;"><label>Link (Quelle)</label><input id="link" type="text"></div>
      </div>
      <input type="file" id="fileInput" multiple style="display:none" onchange="handleFiles(this)">
      <button class="primary-btn" style="background:rgba(255,255,255,0.05); margin-bottom:10px;" onclick="document.getElementById('fileInput').click()">Bilder wÃ¤hlen</button>
      <div id="imagePreview" style="display:flex; gap:10px; margin-bottom:15px; overflow-x:auto;"></div>
      <button class="primary-btn" onclick="addItem()">Artikel Speichern</button>
    </div>
  </div>

  <div id="view-archive" class="view"><div id="archiveList" style="margin-top:20px;"></div></div>
  <div id="view-settings" class="view"><div class="stock-item" id="config-sections" style="margin-top:20px;"></div></div>
</div>

<div class="tabs">
  <div class="tab active" onclick="switchTab('stock', this)"><i class="fa fa-box"></i>Lager</div>
  <div class="tab" onclick="switchTab('add', this)"><i class="fa fa-plus-circle"></i>Neu</div>
  <div class="tab" onclick="switchTab('archive', this)"><i class="fa fa-history"></i>Archiv</div>
  <div class="tab" onclick="switchTab('settings', this)"><i class="fa fa-cog"></i>Konfig</div>
</div>

<script>
const SB_URL = "https://rlxmagieimepjgbgrimu.supabase.co"; 
const SB_KEY = "sb_publishable_-FMIqEzTY5pD3LmRmseJ1A_T5bMWPLk"; 
const IMGBB_API_KEY = "41b752418517f384734a0eb0219a5061";
const supabaseClient = window.supabase.createClient(SB_URL, SB_KEY);

let inventory = [], archive = [], currentImages = [];
let settings = { brands: {}, models: {}, colors: {} };

async function loadCloudData() {
    const { data: items } = await supabaseClient.from('inventory').select('*');
    if(items) {
        inventory = items.filter(i => !i.is_archived).map(i => i.data);
        archive = items.filter(i => i.is_archived).map(i => i.data);
    }
    const { data: cfg } = await supabaseClient.from('config').select('*').eq('id', 1).single();
    if(cfg) settings = cfg.data;
    renderAll();
}

function calcByMarge() {
    const ek = parseFloat(document.getElementById('ek').value) || 0;
    const m = parseFloat(document.getElementById('margeInput').value) || 0;
    if(ek > 0) document.getElementById('vk').value = (ek * (1 + m/100)).toFixed(2);
}
function calcByPrice() {
    const ek = parseFloat(document.getElementById('ek').value) || 0;
    const vk = parseFloat(document.getElementById('vk').value) || 0;
    if(ek > 0 && vk > 0) document.getElementById('margeInput').value = (((vk - ek) / ek) * 100).toFixed(1);
}

function renderStock() {
    const q = document.getElementById('searchInput').value.toLowerCase();
    document.getElementById('stockList').innerHTML = inventory.filter(i => {
        return i.name.toLowerCase().includes(q) || i.sku.toLowerCase().includes(q) || (i.customer && i.customer.toLowerCase().includes(q));
    }).map(i => createItemHTML(i)).join('');
}

async function handleFiles(input) {
    for (const file of input.files) {
        const fd = new FormData(); fd.append("image", file);
        const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: "POST", body: fd });
        const json = await res.json();
        currentImages.push(json.data.url);
    }
    document.getElementById('imagePreview').innerHTML = currentImages.map(img => `<img src="${img}" style="width:50px; height:50px; border-radius:8px; object-fit:cover;">`).join('');
}

// Etiketten-Design nach Bildvorlage
function generateLabel(id) {
    const item = inventory.find(i => i.id === id) || archive.find(i => i.id === id);
    const qrDiv = document.getElementById('qr-hidden');
    qrDiv.innerHTML = "";
    new QRCode(qrDiv, { text: item.id, width: 200, height: 200 });

    setTimeout(() => {
        const qrImg = qrDiv.querySelector('img').src;
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: 'mm', format: [60, 40] });
        doc.setFont("helvetica");

        // Linke Seite: Artikel & SKU
        doc.setFontSize(14); doc.setFont(undefined, 'bold'); doc.text("Artikel", 5, 10);
        doc.setFontSize(12); doc.setFont(undefined, 'normal'); doc.text(item.name.substring(0, 20), 5, 16);
        doc.setFontSize(14); doc.setFont(undefined, 'bold'); doc.text("SKU", 5, 24);
        doc.setFontSize(12); doc.setFont(undefined, 'normal'); doc.text(item.sku, 5, 30);

        // Rechte Seite: GrÃ¶ÃŸe & Farbe
        doc.setFontSize(14); doc.setFont(undefined, 'bold'); doc.text("GrÃ¶ÃŸe", 35, 10);
        doc.setFontSize(12); doc.setFont(undefined, 'normal'); doc.text(item.special || "-", 35, 16);
        doc.setFontSize(14); doc.setFont(undefined, 'bold'); doc.text("Farbe", 35, 24);
        doc.setFontSize(12); doc.setFont(undefined, 'normal'); doc.text(item.colorName || "-", 35, 30);

        // Unten: QR links, Preis rechts
        doc.addImage(qrImg, 'PNG', 5, 32, 15, 15);
        doc.setFontSize(12); doc.setFont(undefined, 'bold'); doc.text("Preis", 55, 34, { align: "right" });
        doc.setFontSize(14); doc.text(`${item.vk.toFixed(2)} â‚¬`, 55, 40, { align: "right" });

        doc.save(`Label_${item.id}.pdf`);
    }, 500);
}

function createItemHTML(item, isArchived = false) {
    return `
    <div class="stock-item" style="${isArchived ? 'opacity:0.7' : ''}">
        ${item.link ? `<a href="${item.link}" target="_blank" class="link-icon"><i class="fa fa-link"></i></a>` : ''}
        <div class="img-container">${item.images.map(img => `<img src="${img}" onclick="openLB('${img}')">`).join('')}</div>
        <div style="display:flex; justify-content:space-between;">
            <div>
                <strong style="font-size:16px;">${item.name}</strong>
                <div class="tag-container">
                    <span class="tag brand">${item.brandName}</span>
                    <span class="tag model">${item.modelName}</span>
                    <span class="tag">ðŸ“¦ ${item.shelf || '-'}</span>
                    ${item.customer ? `<span class="tag">ðŸ‘¤ ${item.customer}</span>` : ''}
                </div>
            </div>
            <span style="font-family:monospace; font-size:9px; color:var(--muted)">${item.sku}</span>
        </div>
        <div class="price-row">
            <div class="p-box"><span>EK</span><strong>${item.ek}â‚¬</strong></div>
            <div class="p-box"><span>VK</span><strong>${item.vk}â‚¬</strong></div>
            <div class="p-box"><span>Profit</span><strong style="color:var(--success)">${(item.vk-item.ek).toFixed(2)}â‚¬</strong></div>
            <div class="p-box"><span>Marge</span><strong>${(((item.vk-item.ek)/item.ek)*100).toFixed(0)}%</strong></div>
        </div>
        <div style="display:flex; gap:8px;">
            <button class="primary-btn" style="flex:1; padding:10px; font-size:11px;" onclick="generateLabel('${item.id}')">LABEL</button>
            ${!isArchived ? `<button class="primary-btn" style="flex:1; padding:10px; font-size:11px; background:var(--success); color:#000;" onclick="sellItem('${item.id}')">VERKAUFT</button>` : ''}
            <button class="primary-btn" style="width:40px; padding:10px; background:rgba(255,77,77,0.1); color:var(--danger);" onclick="deleteItem('${item.id}')"><i class="fa fa-trash"></i></button>
        </div>
    </div>`;
}

async function addItem() {
    const item = {
        id: "PC-" + Date.now(), name: document.getElementById('name').value,
        brandName: settings.brands[document.getElementById('brandSelect').value],
        modelName: settings.models[document.getElementById('modelSelect').value],
        colorName: settings.colors[document.getElementById('colorSelect').value],
        special: document.getElementById('special').value, ek: parseFloat(document.getElementById('ek').value) || 0,
        vk: parseFloat(document.getElementById('vk').value) || 0,
        condition: document.getElementById('condition').value, shelf: document.getElementById('shelf').value,
        customer: document.getElementById('customer').value, link: document.getElementById('link').value, 
        sku: `${document.getElementById('brandSelect').value}/${document.getElementById('modelSelect').value}`,
        images: [...currentImages], date: new Date().toLocaleDateString()
    };
    await supabaseClient.from('inventory').insert([{ id: item.id, data: item, is_archived: false }]);
    currentImages = []; document.getElementById('imagePreview').innerHTML = ""; loadCloudData(); switchTab('stock', document.querySelectorAll('.tab')[0]);
}

async function sellItem(id) { await supabaseClient.from('inventory').update({ is_archived: true }).eq('id', id); loadCloudData(); }
async function deleteItem(id) { if(confirm("LÃ¶schen?")) { await supabaseClient.from('inventory').delete().eq('id', id); loadCloudData(); } }

function renderAll() {
    renderStock();
    document.getElementById('archiveList').innerHTML = archive.map(i => createItemHTML(i, true)).join('');
    ['brandSelect','modelSelect','colorSelect'].forEach(id => {
        const type = id.replace('Select','').toLowerCase() + 's';
        if(document.getElementById(id)) {
            document.getElementById(id).innerHTML = Object.entries(settings[type]).map(([k,v]) => `<option value="${k}">${v}</option>`).join('');
        }
    });
    let h = `<h3>Konfiguration</h3>`;
    ['brands','models','colors'].forEach(t => {
        h += `<label>${t.toUpperCase()}</label><div style="display:flex; flex-wrap:wrap; gap:5px; margin-bottom:10px;">${Object.entries(settings[t]).map(([k,v])=>`<div style="background:rgba(255,255,255,0.06); padding:5px; border-radius:8px; font-size:10px;">${k}: ${v} <i class="fa fa-times" onclick="delCfg('${t}','${k}')" style="color:var(--danger)"></i></div>`).join('')}</div>
        <div style="display:flex; gap:5px; margin-bottom:15px;"><input id="in-k-${t}" placeholder="ID" style="flex:0.3; margin:0;"><input id="in-v-${t}" placeholder="Name" style="flex:1; margin:0;"><button class="primary-btn" style="width:50px; padding:0;" onclick="addCfg('${t}')">+</button></div>`;
    });
    document.getElementById('config-sections').innerHTML = h;
}

function addCfg(t) {
    const k = document.getElementById(`in-k-${t}`).value.toUpperCase().trim(), v = document.getElementById(`in-v-${t}`).value.trim();
    if(k && v) { settings[t][k] = v; saveSettings(); }
}
async function delCfg(t, k) { delete settings[t][k]; saveSettings(); }
async function saveSettings() { await supabaseClient.from('config').upsert({ id: 1, data: settings }); renderAll(); }
function switchTab(v, el) { document.querySelectorAll('.view').forEach(x => x.classList.remove('active')); document.getElementById('view-' + v).classList.add('active'); document.querySelectorAll('.tab').forEach(x => x.classList.remove('active')); el.classList.add('active'); }
function openLB(src) { document.getElementById('lb-img').src = src; document.getElementById('lb').style.display = 'flex'; }
function exportCSV() { 
    let csv = "\ufeffName,Regal,Kunde,EK,VK\n"; 
    inventory.forEach(i => csv += `${i.name},${i.shelf},${i.customer},${i.ek},${i.vk}\n`); 
    const b = new Blob([csv], {type:'text/csv'}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'ProfCalc_Export.csv'; a.click(); 
}
loadCloudData();
</script>
</body>
</html>
